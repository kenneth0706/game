<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¶…ç´šå½ˆç å° - æ±æ±éŠæˆ²ä¸­å¿ƒ</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap">
    <style>
        :root {
            --primary-color: #4a6fa5;
            --secondary-color: #166088;
            --accent-color: #4fc3f7;
            --background-color: #121212;
            --text-color: #e0e0e0;
            --header-bg: #1a1a1a;
            --header-text: #ffffff;
            --ball-color: #FF5252;
            --paddle-color: #4CAF50;
            --brick-colors: ['#FF5252', '#FFD740', '#64FFDA', '#448AFF', '#B388FF'];
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 0;
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
        }

        header {
            background-color: var(--header-bg);
            color: var(--header-text);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        h1 {
            font-size: 1.8rem;
            font-weight: 700;
        }

        .header-controls {
            display: flex;
            gap: 1rem;
        }

        button {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        button:hover {
            background-color: var(--secondary-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .game-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 2rem;
            flex-grow: 1;
            position: relative;
        }

        canvas {
            background-color: #000;
            border: 2px solid #333;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
        }

        .game-info {
            display: flex;
            justify-content: space-between;
            width: 480px;
            margin-bottom: 1rem;
            background-color: #1e1e1e;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .info-box {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .info-title {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.3rem;
        }

        .info-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: var(--accent-color);
        }

        .controls {
            margin-top: 2rem;
            text-align: center;
        }

        .controls-info {
            margin-bottom: 1rem;
            font-size: 0.9rem;
            color: #666;
        }

        .mobile-controls {
            display: none;
        }

        .direction-buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .direction-btn {
            width: 80px;
            height: 60px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            background-color: var(--primary-color);
        }

        footer {
            background-color: var(--header-bg);
            color: var(--header-text);
            text-align: center;
            padding: 1rem;
            margin-top: auto;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #2d2d2d;
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.5);
        }

        .modal h2 {
            margin-bottom: 1rem;
            color: var(--accent-color);
        }

        .modal p {
            margin-bottom: 1rem;
            line-height: 1.6;
        }

        .difficulty-selector {
            margin: 1.5rem 0;
        }

        .difficulty-selector label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .difficulty-selector select {
            width: 100%;
            padding: 0.8rem;
            border-radius: 4px;
            border: 1px solid #444;
            background-color: #3d3d3d;
            color: white;
            font-size: 1rem;
        }

        .powerups {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin: 1.5rem 0;
            justify-content: center;
        }

        .powerup {
            background-color: #3d3d3d;
            padding: 1rem;
            border-radius: 8px;
            width: 120px;
            text-align: center;
        }

        .powerup-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .powerup-name {
            font-weight: bold;
            margin-bottom: 0.3rem;
        }

        .powerup-desc {
            font-size: 0.8rem;
            color: #aaa;
        }

        .key-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .key-control {
            background-color: #3d3d3d;
            padding: 0.8rem;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .key {
            background-color: #1a1a1a;
            color: var(--accent-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        @media (max-width: 768px) {
            .game-info {
                width: 90%;
            }

            canvas {
                width: 100%;
                max-width: 400px;
                height: auto;
            }

            .mobile-controls {
                display: block;
            }

            .desktop-controls {
                display: none;
            }
        }

        @media (max-width: 480px) {
            header {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
            }

            .header-controls {
                width: 100%;
                justify-content: space-between;
            }

            .game-info {
                flex-direction: column;
                gap: 0.5rem;
                align-items: center;
            }
        }

        /* ç²’å­æ•ˆæœ */
        .particle {
            position: absolute;
            border-radius: 50%;
            pointer-events: none;
            z-index: 10;
        }

        /* é€£æ“Šæ•ˆæœ */
        .combo {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #FFD700;
            text-shadow: 0 0 5px #FF0000;
            animation: comboPop 0.5s ease-out;
            pointer-events: none;
            z-index: 20;
        }

        @keyframes comboPop {
            0% { transform: scale(0.5); opacity: 0; }
            50% { transform: scale(1.5); opacity: 1; }
            100% { transform: scale(1); opacity: 0; }
        }
    </style>
</head>
<body>
    <header>
        <h1>è¶…ç´šå½ˆç å° - æ±æ±éŠæˆ²ä¸­å¿ƒ</h1>
        <div class="header-controls">
            <button id="newGameBtn">æ–°éŠæˆ²</button>
            <button id="helpBtn">éŠæˆ²èªªæ˜</button>
            <button id="homeButton">å›åˆ°ä¸»é </button>
        </div>
    </header>

    <div class="game-container">
        <div class="game-info">
            <div class="info-box">
                <div class="info-title">åˆ†æ•¸</div>
                <div class="info-value" id="score">0</div>
            </div>
            <div class="info-box">
                <div class="info-title">ç”Ÿå‘½</div>
                <div class="info-value" id="lives">3</div>
            </div>
            <div class="info-box">
                <div class="info-title">ç­‰ç´š</div>
                <div class="info-value" id="level">1</div>
            </div>
            <div class="info-box">
                <div class="info-title">é€£æ“Š</div>
                <div class="info-value" id="combo">0</div>
            </div>
        </div>

        <canvas id="gameCanvas" width="480" height="320"></canvas>
        
        <div class="controls">
            <p class="controls-info desktop-controls">æ§åˆ¶: æ–¹å‘éµæˆ–æ•¸å­—éµ (1=å·¦ç§», 3=å³ç§», ç©ºæ ¼=ç™¼çƒ)</p>
            
            <div class="mobile-controls">
                <div class="direction-buttons">
                    <button class="direction-btn" onclick="moveLeft()">â† å·¦ç§»</button>
                    <button class="direction-btn" onclick="moveRight()">â†’ å³ç§»</button>
                    <button class="direction-btn" onclick="launchBall()" style="background-color: #f44336;">ç™¼çƒ</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>Â© 2025 æ±æ±éŠæˆ²ä¸­å¿ƒ - è¶…ç´šå½ˆç å°</p>
    </footer>

    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>éŠæˆ²èªªæ˜</h2>
            <p>ä½¿ç”¨æ“‹æ¿åå½ˆçƒé«”ï¼Œæ“Šç¢æ‰€æœ‰ç£šå¡Šå³å¯éé—œã€‚æ¯é—œé›£åº¦æœƒé€æ¼¸æå‡ï¼Œç²å¾—ç‰¹æ®Šèƒ½åŠ›ä¾†å¹«åŠ©ä½ é€šé—œï¼</p>
            
            <div class="key-controls">
                <div class="key-control">
                    <div class="key">â† æˆ– 1</div>
                    <div>å·¦ç§»æ“‹æ¿</div>
                </div>
                <div class="key-control">
                    <div class="key">â†’ æˆ– 3</div>
                    <div>å³ç§»æ“‹æ¿</div>
                </div>
                <div class="key-control">
                    <div class="key">ç©ºæ ¼</div>
                    <div>ç™¼çƒ/ä½¿ç”¨èƒ½åŠ›</div>
                </div>
                <div class="key-control">
                    <div class="key">P</div>
                    <div>æš«åœéŠæˆ²</div>
                </div>
            </div>
            
            <h3>å¾—åˆ†è¦å‰‡</h3>
            <p>- æ™®é€šç£šå¡Š: 10åˆ† Ã— ç­‰ç´š</p>
            <p>- ç‰¹æ®Šç£šå¡Š: 50-200åˆ†</p>
            <p>- é€£æ“Šçå‹µ: æ¯é€£çºŒæ“Šä¸­ç£šå¡Šç²å¾—é¡å¤–åˆ†æ•¸</p>
            <p>- é—œå¡çå‹µ: æ¯é—œå®Œæˆç²å¾—1000åˆ†</p>
            
            <h3>èƒ½åŠ›ç³»çµ±</h3>
            <div class="powerups">
                <div class="powerup">
                    <div class="powerup-icon">ğŸ”¶</div>
                    <div class="powerup-name">é›™å€çƒ</div>
                    <div class="powerup-desc">åŒæ™‚æœ‰å…©å€‹çƒåœ¨å ´ä¸Š</div>
                </div>
                <div class="powerup">
                    <div class="powerup-icon">ğŸ”·</div>
                    <div class="powerup-name">å¤§æ“‹æ¿</div>
                    <div class="powerup-desc">æ“‹æ¿è®Šå¤§30ç§’</div>
                </div>
                <div class="powerup">
                    <div class="powerup-icon">ğŸ’¥</div>
                    <div class="powerup-name">çˆ†ç‚¸çƒ</div>
                    <div class="powerup-desc">çƒå¯ä»¥ç‚¸ç¢å‘¨åœç£šå¡Š</div>
                </div>
                <div class="powerup">
                    <div class="powerup-icon">ğŸ§²</div>
                    <div class="powerup-name">ç£åŠ›</div>
                    <div class="powerup-desc">å¯ä»¥å¸é™„çƒå†ç™¼å°„</div>
                </div>
            </div>
            
            <button id="closeHelpBtn">é—œé–‰</button>
        </div>
    </div>

    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2 id="gameResultTitle">éŠæˆ²çµæŸ!</h2>
            <p>ä½ çš„åˆ†æ•¸: <span id="finalScore">0</span></p>
            <p>æœ€é«˜åˆ†: <span id="finalHighScore">0</span></p>
            <p>é”åˆ°ç­‰ç´š: <span id="finalLevel">1</span></p>
            <p>æ“Šç¢ç£šå¡Š: <span id="finalBricks">0</span></p>
            
            <div class="difficulty-selector">
                <label for="difficulty">é¸æ“‡é›£åº¦:</label>
                <select id="difficulty">
                    <option value="slow">ç°¡å–® (æ…¢é€Ÿ)</option>
                    <option value="normal" selected>æ™®é€š (ä¸­é€Ÿ)</option>
                    <option value="fast">å›°é›£ (å¿«é€Ÿ)</option>
                    <option value="expert">å°ˆå®¶ (æ¥µé€Ÿ)</option>
                </select>
            </div>
            
            <button id="restartBtn">å†ç©ä¸€æ¬¡</button>
        </div>
    </div>

    <div class="modal" id="levelUpModal">
        <div class="modal-content">
            <h2>æ­å–œéé—œ!</h2>
            <p>ä½ å·²æˆåŠŸå®Œæˆç¬¬ <span id="currentLevel">1</span> é—œ</p>
            <p>ç²å¾—çå‹µ: <span id="levelBonus">1000</span> åˆ†</p>
            <p>ä¸‹ä¸€é—œé›£åº¦å°‡æå‡!</p>
            <div id="powerupReward" style="margin: 1rem 0; font-size: 2rem;"></div>
            <button id="nextLevelBtn">é€²å…¥ä¸‹ä¸€é—œ</button>
        </div>
    </div>

    <script>
        // éŠæˆ²å¸¸é‡
        const BRICK_COLORS = [
            '#FF5252', '#FFD740', '#64FFDA', 
            '#448AFF', '#B388FF', '#FF80AB',
            '#69F0AE', '#FFFF00', '#00BFA5'
        ];
        const BRICK_TYPES = {
            NORMAL: 1,
            HARD: 2,
            UNBREAKABLE: 3,
            SPEED_UP: 4,
            POWER_UP: 5,
            BONUS: 6
        };
        
        // éŠæˆ²è®Šæ•¸
        let canvas, ctx;
        let ball = {
            x: 0,
            y: 0,
            dx: 0,
            dy: 0,
            radius: 8,
            speed: 4,
            active: false
        };
        let balls = [];
        let paddle = {
            width: 75,
            height: 10,
            x: 0,
            speed: 8,
            isSticky: false,
            isLarge: false,
            largeEndTime: 0
        };
        let bricks = [];
        let score = 0;
        let highScore = localStorage.getItem('breakoutHighScore') || 0;
        let lives = 3;
        let level = 1;
        let combo = 0;
        let maxCombo = 0;
        let comboTimeout;
        let gameOver = false;
        let isPaused = false;
        let brickRowCount = 5;
        let brickColumnCount = 8;
        let brickWidth = 50;
        let brickHeight = 20;
        let brickPadding = 10;
        let brickOffsetTop = 30;
        let brickOffsetLeft = 30;
        let rightPressed = false;
        let leftPressed = false;
        let spacePressed = false;
        let lastTime = 0;
        let animationId;
        let difficulty = 'normal';
        let powerups = [];
        let activePowerups = [];
        let particles = [];
        
        // åˆå§‹åŒ–éŠæˆ²
        function init() {
            canvas = document.getElementById('gameCanvas');
            ctx = canvas.getContext('2d');
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            resetGame();
            
            // è¨­ç½®äº‹ä»¶ç›£è½å™¨
            setupEventListeners();
            
            // é–‹å§‹éŠæˆ²å¾ªç’°
            lastTime = performance.now();
            gameLoop(lastTime);
        }
        
        // é‡ç½®éŠæˆ²ç‹€æ…‹
        function resetGame() {
            // åˆå§‹åŒ–çƒ
            ball = {
                x: canvas.width / 2,
                y: canvas.height - 30,
                dx: 0,
                dy: 0,
                radius: 8,
                speed: getBallSpeed(),
                active: false,
                isFireball: false,
                fireballEndTime: 0
            };
            balls = [ball];
            
            // åˆå§‹åŒ–æ“‹æ¿
            paddle = {
                width: 75,
                height: 10,
                x: (canvas.width - 75) / 2,
                speed: 8,
                isSticky: false,
                isLarge: false,
                largeEndTime: 0
            };
            
            // åˆå§‹åŒ–ç£šå¡Š
            createBricks();
            
            // æ›´æ–°é¡¯ç¤º
            updateScoreDisplay();
            
            // é‡ç½®éŠæˆ²ç‹€æ…‹
            gameOver = false;
            isPaused = false;
        }
        
        // å‰µå»ºç£šå¡Šå¸ƒå±€
        function createBricks() {
            bricks = [];
            brickRowCount = 5 + Math.floor(level / 2);
            brickColumnCount = 8 + Math.floor(level / 3);
            
            // èª¿æ•´ç£šå¡Šå¤§å°ä»¥é©æ‡‰ç•«å¸ƒ
            const availableWidth = canvas.width - brickOffsetLeft * 2;
            brickWidth = Math.max(30, Math.floor((availableWidth - (brickColumnCount - 1) * brickPadding) / brickColumnCount));
            
            for (let c = 0; c < brickColumnCount; c++) {
                bricks[c] = [];
                for (let r = 0; r < brickRowCount; r++) {
                    // éš¨æ©Ÿæ±ºå®šç£šå¡Šé¡å‹ (é«˜ç´šé—œå¡æœ‰æ›´å¤šç‰¹æ®Šç£šå¡Š)
                    let type = BRICK_TYPES.NORMAL;
                    const rand = Math.random();
                    
                    if (level > 3 && rand < 0.05) {
                        type = BRICK_TYPES.UNBREAKABLE;
                    } else if (level > 2 && rand < 0.1) {
                        type = BRICK_TYPES.HARD;
                    } else if (level > 1 && rand < 0.1) {
                        type = BRICK_TYPES.POWER_UP;
                    } else if (rand < 0.1) {
                        type = BRICK_TYPES.BONUS;
                    } else if (rand < 0.15) {
                        type = BRICK_TYPES.SPEED_UP;
                    }
                    
                    bricks[c][r] = {
                        x: 0,
                        y: 0,
                        status: 1,
                        type: type,
                        hits: type === BRICK_TYPES.HARD ? 2 : 1
                    };
                }
            }
        }
        
        // è¨­ç½®äº‹ä»¶ç›£è½å™¨
        function setupEventListeners() {
            document.addEventListener('keydown', keyDownHandler);
            document.addEventListener('keyup', keyUpHandler);
            document.addEventListener('mousemove', mouseMoveHandler);
            
            // æŒ‰éˆ•äº‹ä»¶
            document.getElementById('newGameBtn').addEventListener('click', startNewGame);
            document.getElementById('helpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').style.display = 'flex';
            });
            document.getElementById('closeHelpBtn').addEventListener('click', () => {
                document.getElementById('helpModal').style.display = 'none';
            });
            document.getElementById('restartBtn').addEventListener('click', startNewGame);
            document.getElementById('homeButton').addEventListener('click', () => {
                window.location.href = "index.html";
            });
            document.getElementById('nextLevelBtn').addEventListener('click', nextLevel);
            
            // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
            window.addEventListener('click', (e) => {
                if (e.target === document.getElementById('helpModal')) {
                    document.getElementById('helpModal').style.display = 'none';
                }
                if (e.target === document.getElementById('gameOverModal')) {
                    document.getElementById('gameOverModal').style.display = 'none';
                }
            });
        }
        
        // æ ¹æ“šé›£åº¦ç²å–çƒé€Ÿ
        function getBallSpeed() {
            switch(difficulty) {
                case 'slow': return 3;
                case 'normal': return 4;
                case 'fast': return 5;
                case 'expert': return 6;
                default: return 4;
            }
        }
        
        // éŠæˆ²ä¸»å¾ªç’°
        function gameLoop(timestamp) {
            const deltaTime = timestamp - lastTime;
            lastTime = timestamp;
            
            if (!gameOver && !isPaused) {
                // æ¸…é™¤ç•«å¸ƒ
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                // ç¹ªè£½éŠæˆ²å…ƒç´ 
                drawBricks();
                drawPaddle();
                drawBalls();
                drawPowerups();
                drawParticles();
                
                // æ›´æ–°éŠæˆ²ç‹€æ…‹
                updateBalls(deltaTime);
                updatePaddle();
                updatePowerups(deltaTime);
                updateParticles(deltaTime);
                
                // ç¢°æ’æª¢æ¸¬
                collisionDetection();
                
                // æª¢æŸ¥éŠæˆ²ç‹€æ…‹
                checkGameState();
            }
            
            animationId = requestAnimationFrame(gameLoop);
        }
        
        // ç¹ªè£½ç£šå¡Š
        function drawBricks() {
            for (let c = 0; c < bricks.length; c++) {
                for (let r = 0; r < bricks[c].length; r++) {
                    const brick = bricks[c][r];
                    if (brick.status === 1) {
                        const brickX = c * (brickWidth + brickPadding) + brickOffsetLeft;
                        const brickY = r * (brickHeight + brickPadding) + brickOffsetTop;
                        brick.x = brickX;
                        brick.y = brickY;
                        
                        // æ ¹æ“šç£šå¡Šé¡å‹è¨­ç½®é¡è‰²
                        let color;
                        switch(brick.type) {
                            case BRICK_TYPES.HARD:
                                color = '#9E9E9E'; // ç°è‰²
                                break;
                            case BRICK_TYPES.UNBREAKABLE:
                                color = '#212121'; // æ·±ç°è‰²
                                break;
                            case BRICK_TYPES.SPEED_UP:
                                color = '#FFC107'; // ç¥ç€è‰²
                                break;
                            case BRICK_TYPES.POWER_UP:
                                color = '#9C27B0'; // ç´«è‰²
                                break;
                            case BRICK_TYPES.BONUS:
                                color = '#FFEB3B'; // é»ƒè‰²
                                break;
                            default:
                                // æ™®é€šç£šå¡Šä½¿ç”¨å½©è™¹è‰²
                                color = BRICK_COLORS[r % BRICK_COLORS.length];
                        }
                        
                        ctx.beginPath();
                        ctx.rect(brickX, brickY, brickWidth, brickHeight);
                        ctx.fillStyle = color;
                        ctx.fill();
                        
                        // æ·»åŠ ç£šå¡Šç´°ç¯€
                        if (brick.type === BRICK_TYPES.HARD) {
                            ctx.strokeStyle = '#616161';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(brickX + 2, brickY + 2, brickWidth - 4, brickHeight - 4);
                        } else if (brick.type === BRICK_TYPES.UNBREAKABLE) {
                            ctx.strokeStyle = '#424242';
                            ctx.lineWidth = 2;
                            ctx.strokeRect(brickX + 2, brickY + 2, brickWidth - 4, brickHeight - 4);
                            ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                            ctx.fillRect(brickX + 4, brickY + 4, brickWidth - 8, brickHeight - 8);
                        } else if (brick.type === BRICK_TYPES.POWER_UP) {
                            ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
                            ctx.beginPath();
                            ctx.arc(
                                brickX + brickWidth / 2, 
                                brickY + brickHeight / 2, 
                                Math.min(brickWidth, brickHeight) / 3, 
                                0, 
                                Math.PI * 2
                            );
                            ctx.fill();
                        }
                        
                        ctx.closePath();
                    }
                }
            }
        }
        
        // ç¹ªè£½æ“‹æ¿
        function drawPaddle() {
            const width = paddle.isLarge ? paddle.width * 1.5 : paddle.width;
            const x = paddle.isLarge ? paddle.x - (width - paddle.width) / 2 : paddle.x;
            
            ctx.beginPath();
            ctx.rect(x, canvas.height - paddle.height, width, paddle.height);
            
            // æ¼¸è®Šè‰²
            const gradient = ctx.createLinearGradient(x, 0, x + width, 0);
            gradient.addColorStop(0, '#4CAF50');
            gradient.addColorStop(1, '#8BC34A');
            ctx.fillStyle = gradient;
            
            ctx.fill();
            ctx.closePath();
            
            // å¦‚æœæ˜¯ç²˜æ€§æ“‹æ¿ï¼Œæ·»åŠ æ•ˆæœ
            if (paddle.isSticky) {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.beginPath();
                ctx.arc(
                    x + width / 2, 
                    canvas.height - paddle.height, 
                    width / 4, 
                    0, 
                    Math.PI
                );
                ctx.fill();
                ctx.closePath();
            }
        }
        
        // ç¹ªè£½çƒ
        function drawBalls() {
            balls.forEach(b => {
                if (!b.active) return;
                
                ctx.beginPath();
                ctx.arc(b.x, b.y, b.radius, 0, Math.PI * 2);
                
                // å¦‚æœæ˜¯ç«çƒï¼Œä½¿ç”¨ç«ç„°æ•ˆæœ
                if (b.isFireball) {
                    const gradient = ctx.createRadialGradient(
                        b.x, b.y, b.radius / 2,
                        b.x, b.y, b.radius
                    );
                    gradient.addColorStop(0, '#FF5722');
                    gradient.addColorStop(1, '#FFC107');
                    ctx.fillStyle = gradient;
                    
                    // ç«ç„°æ•ˆæœ
                    for (let i = 0; i < 3; i++) {
                        ctx.beginPath();
                        ctx.arc(
                            b.x + (Math.random() - 0.5) * b.radius, 
                            b.y + (Math.random() - 0.5) * b.radius, 
                            b.radius * (0.3 + Math.random() * 0.7), 
                            0, 
                            Math.PI * 2
                        );
                        ctx.fill();
                    }
                } else {
                    // æ™®é€šçƒä½¿ç”¨æ¼¸è®Šè‰²
                    const gradient = ctx.createRadialGradient(
                        b.x, b.y, 0,
                        b.x, b.y, b.radius
                    );
                    gradient.addColorStop(0, '#2196F3');
                    gradient.addColorStop(1, '#0D47A1');
                    ctx.fillStyle = gradient;
                }
                
                ctx.fill();
                ctx.closePath();
            });
        }
        
        // ç¹ªè£½èƒ½åŠ›é“å…·
        function drawPowerups() {
            powerups.forEach(pu => {
                ctx.beginPath();
                ctx.rect(pu.x, pu.y, pu.width, pu.height);
                
                // æ ¹æ“šèƒ½åŠ›é¡å‹è¨­ç½®é¡è‰²
                switch(pu.type) {
                    case 'extra_ball':
                        ctx.fillStyle = '#2196F3';
                        break;
                    case 'large_paddle':
                        ctx.fillStyle = '#4CAF50';
                        break;
                    case 'fire_ball':
                        ctx.fillStyle = '#FF5722';
                        break;
                    case 'sticky_paddle':
                        ctx.fillStyle = '#9C27B0';
                        break;
                    default:
                        ctx.fillStyle = '#607D8B';
                }
                
                ctx.fill();
                
                // æ·»åŠ åœ–æ¨™
                ctx.fillStyle = 'white';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                let icon = '';
                switch(pu.type) {
                    case 'extra_ball': icon = 'ğŸ”¶'; break;
                    case 'large_paddle': icon = 'ğŸ”·'; break;
                    case 'fire_ball': icon = 'ğŸ’¥'; break;
                    case 'sticky_paddle': icon = 'ğŸ§²'; break;
                }
                
                ctx.fillText(icon, pu.x + pu.width / 2, pu.y + pu.height / 2);
                ctx.closePath();
            });
        }
        
        // ç¹ªè£½ç²’å­æ•ˆæœ
        function drawParticles() {
            particles.forEach(p => {
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.radius, 0, Math.PI * 2);
                ctx.fillStyle = p.color;
                ctx.globalAlpha = p.opacity;
                ctx.fill();
                ctx.globalAlpha = 1;
                ctx.closePath();
            });
        }
        
        // æ›´æ–°çƒçš„ä½ç½®
        function updateBalls(deltaTime) {
            balls.forEach(b => {
                if (!b.active) return;
                
                // æ›´æ–°ä½ç½®
                b.x += b.dx * b.speed * (deltaTime / 16);
                b.y += b.dy * b.speed * (deltaTime / 16);
                
                // æª¢æŸ¥ç«çƒç‹€æ…‹æ˜¯å¦çµæŸ
                if (b.isFireball && performance.now() > b.fireballEndTime) {
                    b.isFireball = false;
                }
                
                // é‚Šç•Œç¢°æ’æª¢æ¸¬
                if (b.x + b.dx > canvas.width - b.radius || b.x + b.dx < b.radius) {
                    b.dx = -b.dx;
                }
                
                if (b.y + b.dy < b.radius) {
                    b.dy = -b.dy;
                }
            });
        }
        
        // æ›´æ–°æ“‹æ¿ä½ç½®
        function updatePaddle() {
            const width = paddle.isLarge ? paddle.width * 1.5 : paddle.width;
            
            if (rightPressed && paddle.x < canvas.width - width) {
                paddle.x += paddle.speed;
            } else if (leftPressed && paddle.x > 0) {
                paddle.x -= paddle.speed;
            }
            
            // æª¢æŸ¥å¤§æ“‹æ¿ç‹€æ…‹æ˜¯å¦çµæŸ
            if (paddle.isLarge && performance.now() > paddle.largeEndTime) {
                paddle.isLarge = false;
            }
        }
        
        // æ›´æ–°èƒ½åŠ›é“å…·ä½ç½®
        function updatePowerups(deltaTime) {
            for (let i = powerups.length - 1; i >= 0; i--) {
                const pu = powerups[i];
                pu.y += 2 * (deltaTime / 16);
                
                // æª¢æŸ¥æ˜¯å¦ç¢°åˆ°æ“‹æ¿
                const width = paddle.isLarge ? paddle.width * 1.5 : paddle.width;
                const paddleX = paddle.isLarge ? paddle.x - (width - paddle.width) / 2 : paddle.x;
                
                if (
                    pu.y + pu.height >= canvas.height - paddle.height &&
                    pu.x + pu.width >= paddleX &&
                    pu.x <= paddleX + width
                ) {
                    // ç²å¾—èƒ½åŠ›
                    activatePowerup(pu.type);
                    powerups.splice(i, 1);
                    
                    // æ·»åŠ ç²’å­æ•ˆæœ
                    createParticles(pu.x + pu.width / 2, pu.y + pu.height / 2, 10, pu.color);
                } else if (pu.y > canvas.height) {
                    // ç§»é™¤è¶…å‡ºå±å¹•çš„èƒ½åŠ›
                    powerups.splice(i, 1);
                }
            }
        }
        
        // æ›´æ–°ç²’å­æ•ˆæœ
        function updateParticles(deltaTime) {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                
                // æ›´æ–°ä½ç½®å’Œå±¬æ€§
                p.x += p.vx * (deltaTime / 16);
                p.y += p.vy * (deltaTime / 16);
                p.radius -= 0.1 * (deltaTime / 16);
                p.opacity -= 0.02 * (deltaTime / 16);
                
                // ç§»é™¤ä¸å¯è¦‹çš„ç²’å­
                if (p.radius <= 0 || p.opacity <= 0) {
                    particles.splice(i, 1);
                }
            }
        }
        
        // ç¢°æ’æª¢æ¸¬
        function collisionDetection() {
            balls.forEach(b => {
                if (!b.active) return;
                
                // æª¢æŸ¥æ˜¯å¦ç¢°åˆ°æ“‹æ¿
                const width = paddle.isLarge ? paddle.width * 1.5 : paddle.width;
                const paddleX = paddle.isLarge ? paddle.x - (width - paddle.width) / 2 : paddle.x;
                
                if (
                    b.y + b.radius >= canvas.height - paddle.height &&
                    b.x + b.radius >= paddleX &&
                    b.x - b.radius <= paddleX + width
                ) {
                    // è¨ˆç®—åå½ˆè§’åº¦ (æ ¹æ“šæ“Šä¸­æ“‹æ¿çš„ä½ç½®)
                    const hitPos = (b.x - paddleX) / width;
                    const angle = hitPos * Math.PI - Math.PI / 2; // -90Â° åˆ° 90Â°
                    
                    // è¨­ç½®æ–°çš„æ–¹å‘å‘é‡
                    b.dx = Math.sin(angle);
                    b.dy = -Math.cos(angle);
                    
                    // æ¨™æº–åŒ–å‘é‡ (ä¿æŒé€Ÿåº¦ä¸è®Š)
                    const length = Math.sqrt(b.dx * b.dx + b.dy * b.dy);
                    b.dx /= length;
                    b.dy /= length;
                    
                    // å¦‚æœæ˜¯ç²˜æ€§æ“‹æ¿ï¼Œå¸é™„çƒ
                    if (paddle.isSticky && !spacePressed) {
                        b.active = false;
                        b.x = paddleX + width / 2;
                        b.y = canvas.height - paddle.height - b.radius;
                    }
                    
                    // æ·»åŠ ç²’å­æ•ˆæœ
                    createParticles(b.x, b.y, 5, '#FFFFFF');
                }
                
                // æª¢æŸ¥æ˜¯å¦æ‰å‡ºå±å¹•åº•éƒ¨
                if (b.y + b.radius > canvas.height) {
                    b.active = false;
                    
                    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…¶ä»–æ´»å‹•çš„çƒ
                    const activeBalls = balls.filter(ball => ball.active);
                    if (activeBalls.length === 0) {
                        loseLife();
                    }
                    
                    return;
                }
                </script>
</body>
</html>
