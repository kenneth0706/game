<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>貪吃蛇 - 東東遊戲中心</title>
    <!-- 使用基本字體確保兼容性 -->
    <style>
        /* 基本重置與兼容性樣式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, "Microsoft JhengHei", sans-serif;
            background-color: #f0f0f0;
            color: #333;
            line-height: 1.6;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 兼容性標頭樣式 */
        header {
            background: #166088;
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        h1 {
            font-size: 24px;
            font-weight: bold;
        }
        
        .header-controls {
            display: flex;
            gap: 10px;
        }
        
        button {
            background: #4a6fa5;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #3a5a80;
        }
        
        /* 主遊戲區域 */
        .game-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        
        .game-info {
            display: flex;
            justify-content: space-between;
            width: 100%;
            max-width: 600px;
            margin-bottom: 15px;
            background: white;
            padding: 15px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .score-display, .high-score-display {
            font-size: 18px;
            font-weight: bold;
        }
        
        canvas {
            background: black;
            border-radius: 5px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            max-width: 100%;
        }
        
        /* 控制區域 */
        .controls {
            margin-top: 20px;
            width: 100%;
            max-width: 600px;
            text-align: center;
        }
        
        .controls-info {
            margin-bottom: 10px;
            font-size: 14px;
            color: #666;
        }
        
        .mobile-controls {
            display: none;
        }
        
        .direction-buttons {
            display: inline-grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 5px;
            margin-top: 10px;
        }
        
        .direction-btn {
            width: 50px;
            height: 50px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
        }
        
        .direction-btn.up { grid-area: up; }
        .direction-btn.left { grid-area: left; }
        .direction-btn.right { grid-area: right; }
        .direction-btn.down { grid-area: down; }
        
        /* 頁尾 */
        footer {
            background: #166088;
            color: white;
            text-align: center;
            padding: 15px;
            font-size: 14px;
        }
        
        /* 模態框 - 使用傳統顯示/隱藏方式確保兼容性 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 100;
            overflow: auto;
        }
        
        .modal-content {
            background: white;
            margin: 10% auto;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .modal h2 {
            color: #166088;
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .modal p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .modal ul {
            margin-bottom: 15px;
            padding-left: 20px;
        }
        
        .modal button {
            margin-top: 10px;
        }
        
        /* 遊戲模式選擇 */
        .game-modes {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin: 15px 0;
            justify-content: center;
        }
        
        .mode-btn {
            padding: 10px 15px;
            background: #e0e0e0;
            color: #333;
            border: 2px solid #ccc;
            font-weight: bold;
        }
        
        .mode-btn.active {
            background: #4a6fa5;
            color: white;
            border-color: #3a5a80;
        }
        
        /* 響應式設計 */
        @media (max-width: 768px) {
            header {
                flex-direction: column;
                gap: 10px;
                padding: 15px;
            }
            
            .header-controls {
                width: 100%;
            }
            
            .mobile-controls {
                display: block;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 20px;
            }
            
            .game-info {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-content {
                margin: 20px auto;
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1>貪吃蛇 - 東東遊戲中心</h1>
        <div class="header-controls">
            <button id="newGameBtn">新遊戲</button>
            <button id="helpBtn">遊戲說明</button>
            <button id="homeButton">回到主頁</button>
        </div>
    </header>

    <div class="game-container">
        <div class="game-info">
            <div class="score-display">分數: <span id="score">0</span></div>
            <div class="high-score-display">最高分: <span id="highScore">0</span></div>
        </div>

        <div class="game-modes">
            <button class="mode-btn active" data-mode="classic">經典模式</button>
            <button class="mode-btn" data-mode="infinite">無限模式</button>
            <button class="mode-btn" data-mode="walls">障礙模式</button>
        </div>

        <canvas id="snakeCanvas" width="600" height="600"></canvas>

        <div class="controls">
            <p class="controls-info desktop-controls">使用方向鍵控制 (↑ ↓ ← →) 或 WASD 鍵</p>
            
            <div class="mobile-controls">
                <p class="controls-info">點擊按鈕控制方向</p>
                <div class="direction-buttons">
                    <button class="direction-btn up" onclick="changeDirection('UP')">↑</button>
                    <button class="direction-btn left" onclick="changeDirection('LEFT')">←</button>
                    <button class="direction-btn right" onclick="changeDirection('RIGHT')">→</button>
                    <button class="direction-btn down" onclick="changeDirection('DOWN')">↓</button>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <p>© 2025 東東遊戲中心 - 貪吃蛇遊戲</p>
    </footer>

    <!-- 遊戲說明模態框 -->
    <div class="modal" id="helpModal">
        <div class="modal-content">
            <h2>遊戲說明</h2>
            <p>控制蛇移動並吃掉食物來增加分數。不同模式有不同規則：</p>
            
            <h3>遊戲模式</h3>
            <ul>
                <li><strong>經典模式</strong>: 撞牆或撞到自己身體遊戲結束</li>
                <li><strong>無限模式</strong>: 可以穿牆，但撞到自己身體仍會結束</li>
                <li><strong>障礙模式</strong>: 場地中有固定障礙物</li>
            </ul>
            
            <h3>控制方式</h3>
            <p>鍵盤: 方向鍵 (↑ ↓ ← →) 或 WASD 鍵</p>
            <p>手機: 使用屏幕上的方向按鈕</p>
            
            <h3>遊戲技巧</h3>
            <p>- 金色食物得30分，普通食物得10分</p>
            <p>- 空格鍵可暫停遊戲</p>
            <p>- 分數越高，速度越快</p>
            
            <button id="closeHelpBtn">關閉</button>
        </div>
    </div>

    <!-- 遊戲結束模態框 -->
    <div class="modal" id="gameOverModal">
        <div class="modal-content">
            <h2>遊戲結束!</h2>
            <p>你的分數: <span id="finalScore">0</span></p>
            <p>最高分: <span id="finalHighScore">0</span></p>
            
            <div>
                <label for="difficulty">選擇難度:</label>
                <select id="difficulty" style="width:100%; padding:8px; margin:10px 0;">
                    <option value="150">簡單 (慢速)</option>
                    <option value="100" selected>普通 (中速)</option>
                    <option value="70">困難 (快速)</option>
                    <option value="40">專家 (極速)</option>
                </select>
            </div>
            
            <button id="restartBtn">再玩一次</button>
        </div>
    </div>

    <script>
        // 兼容性檢查與polyfill
        if (!window.requestAnimationFrame) {
            window.requestAnimationFrame = function(callback) {
                return setTimeout(callback, 16);
            };
        }
        
        // 遊戲元素
        var canvas = document.getElementById('snakeCanvas');
        var ctx = canvas.getContext('2d');
        var scoreDisplay = document.getElementById('score');
        var highScoreDisplay = document.getElementById('highScore');
        
        // 模態框元素
        var helpModal = document.getElementById('helpModal');
        var gameOverModal = document.getElementById('gameOverModal');
        var finalScoreDisplay = document.getElementById('finalScore');
        var finalHighScoreDisplay = document.getElementById('finalHighScore');
        
        // 按鈕元素
        var newGameBtn = document.getElementById('newGameBtn');
        var helpBtn = document.getElementById('helpBtn');
        var closeHelpBtn = document.getElementById('closeHelpBtn');
        var restartBtn = document.getElementById('restartBtn');
        var homeButton = document.getElementById('homeButton');
        var modeBtns = document.querySelectorAll('.mode-btn');
        
        // 遊戲變數
        var gridSize = 20;
        var snake = [];
        var direction = '';
        var nextDirection = '';
        var food = {};
        var walls = [];
        var score = 0;
        var highScore = localStorage.getItem('snakeHighScore') || 0;
        var speed = 100; // 初始速度 (毫秒)
        var gameInterval;
        var isPaused = false;
        var gameStarted = false;
        var currentMode = 'classic'; // classic, infinite, walls
        
        // 初始化遊戲
        function initGame() {
            // 設置畫布大小 (兼容性處理)
            var canvasSize = Math.min(600, window.innerWidth - 40);
            canvas.width = canvasSize;
            canvas.height = canvasSize;
            
            // 確保畫布大小是gridSize的倍數
            canvas.width = Math.floor(canvas.width / gridSize) * gridSize;
            canvas.height = Math.floor(canvas.height / gridSize) * gridSize;
            
            // 重置遊戲狀態
            snake = [
                {x: Math.floor(canvas.width / 2 / gridSize) * gridSize, y: Math.floor(canvas.height / 2 / gridSize) * gridSize},
                {x: Math.floor(canvas.width / 2 / gridSize) * gridSize - gridSize, y: Math.floor(canvas.height / 2 / gridSize) * gridSize},
                {x: Math.floor(canvas.width / 2 / gridSize) * gridSize - gridSize * 2, y: Math.floor(canvas.height / 2 / gridSize) * gridSize}
            ];
            
            direction = 'RIGHT';
            nextDirection = 'RIGHT';
            score = 0;
            speed = parseInt(document.getElementById('difficulty').value) || 100;
            scoreDisplay.textContent = score;
            highScoreDisplay.textContent = highScore;
            
            // 根據模式生成牆壁
            generateWalls();
            generateFood();
            drawGame();
            
            if (gameInterval) clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, speed);
            gameStarted = true;
        }
        
        // 生成牆壁 (障礙模式)
        function generateWalls() {
            walls = [];
            
            if (currentMode === 'walls') {
                // 中心十字牆
                var centerX = Math.floor(canvas.width / 2 / gridSize) * gridSize;
                var centerY = Math.floor(canvas.height / 2 / gridSize) * gridSize;
                
                // 水平牆
                for (var x = centerX - gridSize * 5; x <= centerX + gridSize * 5; x += gridSize) {
                    if (x >= 0 && x < canvas.width && centerY >= 0 && centerY < canvas.height) {
                        walls.push({x: x, y: centerY});
                    }
                }
                
                // 垂直牆 (避開中心點以免擋住蛇的初始位置)
                for (var y = centerY - gridSize * 5; y <= centerY + gridSize * 5; y += gridSize) {
                    if (y >= 0 && y < canvas.height && centerX >= 0 && centerX < canvas.width) {
                        if (y !== centerY) { // 避開中心點
                            walls.push({x: centerX, y: y});
                        }
                    }
                }
            }
        }
        
        // 生成食物
        function generateFood() {
            var maxX = Math.floor(canvas.width / gridSize) - 1;
            var maxY = Math.floor(canvas.height / gridSize) - 1;
            
            // 確保食物不會生成在蛇身上或牆上
            var validPosition = false;
            while (!validPosition) {
                food = {
                    x: Math.floor(Math.random() * maxX) * gridSize,
                    y: Math.floor(Math.random() * maxY) * gridSize
                };
                
                validPosition = true;
                
                // 檢查是否與蛇重疊
                for (var i = 0; i < snake.length; i++) {
                    if (snake[i].x === food.x && snake[i].y === food.y) {
                        validPosition = false;
                        break;
                    }
                }
                
                // 檢查是否與牆重疊 (障礙模式)
                if (validPosition && currentMode === 'walls') {
                    for (var j = 0; j < walls.length; j++) {
                        if (walls[j].x === food.x && walls[j].y === food.y) {
                            validPosition = false;
                            break;
                        }
                    }
                }
            }
            
            // 10%機率生成特殊食物 (金色)
            food.special = Math.random() < 0.1;
        }
        
        // 繪製遊戲
        function drawGame() {
            // 清除畫布
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // 繪製網格 (背景)
            drawGrid();
            
            // 繪製牆壁 (障礙模式)
            drawWalls();
            
            // 繪製蛇
            drawSnake();
            
            // 繪製食物
            drawFood();
            
            // 如果暫停，顯示暫停訊息
            if (isPaused) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('已暫停', canvas.width / 2, canvas.height / 2);
            }
            
            // 如果遊戲未開始，顯示開始訊息
            if (!gameStarted) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = 'white';
                ctx.font = 'bold 24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('按任意鍵開始遊戲', canvas.width / 2, canvas.height / 2 - 20);
                ctx.font = '16px Arial';
                ctx.fillText('當前模式: ' + getModeName(currentMode), canvas.width / 2, canvas.height / 2 + 20);
            }
        }
        
        // 獲取模式名稱
        function getModeName(mode) {
            switch(mode) {
                case 'classic': return '經典模式';
                case 'infinite': return '無限模式';
                case 'walls': return '障礙模式';
                default: return mode;
            }
        }
        
        // 繪製網格
        function drawGrid() {
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 0.5;
            
            for (var x = 0; x < canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (var y = 0; y < canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        // 繪製牆壁
        function drawWalls() {
            if (currentMode !== 'walls') return;
            
            ctx.fillStyle = '#666';
            for (var i = 0; i < walls.length; i++) {
                ctx.fillRect(walls[i].x, walls[i].y, gridSize, gridSize);
                ctx.strokeStyle = '#333';
                ctx.strokeRect(walls[i].x, walls[i].y, gridSize, gridSize);
            }
        }
        
        // 繪製蛇
        function drawSnake() {
            // 繪製蛇身
            for (var i = 0; i < snake.length; i++) {
                var segment = snake[i];
                
                // 蛇頭用不同顏色
                if (i === 0) {
                    ctx.fillStyle = '#4CAF50'; // 蛇頭綠色
                } else {
                    // 簡單的蛇身顏色 (避免使用HSL以確保兼容性)
                    ctx.fillStyle = i % 2 === 0 ? '#2E7D32' : '#388E3C';
                }
                
                ctx.fillRect(segment.x, segment.y, gridSize, gridSize);
                ctx.strokeStyle = '#000';
                ctx.strokeRect(segment.x, segment.y, gridSize, gridSize);
            }
            
            // 繪製蛇眼 (只在蛇頭)
            var head = snake[0];
            ctx.fillStyle = 'white';
            
            // 根據方向決定眼睛位置
            if (direction === 'RIGHT' || direction === 'LEFT') {
                ctx.fillRect(head.x + 5, head.y + 5, 5, 5);
                ctx.fillRect(head.x + 5, head.y + 10, 5, 5);
            } else {
                ctx.fillRect(head.x + 5, head.y + 5, 5, 5);
                ctx.fillRect(head.x + 10, head.y + 5, 5, 5);
            }
        }
        
        // 繪製食物
        function drawFood() {
            if (food.special) {
                // 特殊食物 (金色)
                ctx.fillStyle = '#FFD700';
            } else {
                // 普通食物 (紅色)
                ctx.fillStyle = '#FF5252';
            }
            
            // 簡單的圓形食物 (避免使用arc的複雜繪製)
            ctx.beginPath();
            ctx.arc(food.x + gridSize/2, food.y + gridSize/2, gridSize/2 - 2, 0, Math.PI * 2);
            ctx.fill();
            
            // 如果是特殊食物，添加星形標記
            if (food.special) {
                ctx.fillStyle = 'white';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('★', food.x + gridSize/2, food.y + gridSize/2);
            }
        }
        
        // 更新蛇的位置
        function updateSnake() {
            // 只在遊戲開始且未暫停時更新
            if (!gameStarted || isPaused) return;
            
            // 更新方向
            direction = nextDirection;
            
            // 計算新蛇頭位置
            var head = {x: snake[0].x, y: snake[0].y};
            
            switch (direction) {
                case 'UP':
                    head.y -= gridSize;
                    break;
                case 'DOWN':
                    head.y += gridSize;
                    break;
                case 'LEFT':
                    head.x -= gridSize;
                    break;
                case 'RIGHT':
                    head.x += gridSize;
                    break;
            }
            
            // 無限模式處理穿牆
            if (currentMode === 'infinite') {
                if (head.x < 0) head.x = canvas.width - gridSize;
                if (head.x >= canvas.width) head.x = 0;
                if (head.y < 0) head.y = canvas.height - gridSize;
                if (head.y >= canvas.height) head.y = 0;
            }
            
            // 將新頭部添加到蛇身
            snake.unshift(head);
            
            // 檢查是否吃到食物
            if (head.x === food.x && head.y === food.y) {
                // 增加分數
                score += food.special ? 30 : 10; // 特殊食物得30分
                scoreDisplay.textContent = score;
                
                // 更新最高分
                if (score > highScore) {
                    highScore = score;
                    highScoreDisplay.textContent = highScore;
                    localStorage.setItem('snakeHighScore', highScore);
                }
                
                // 每得100分增加速度 (最多到50ms)
                if (score % 100 === 0 && speed > 50) {
                    speed -= 5;
                    restartGameLoop();
                }
                
                // 生成新食物
                generateFood();
            } else {
                // 如果沒吃到食物，移除尾部
                snake.pop();
            }
        }
        
        // 檢查碰撞
        function checkCollision() {
            var head = snake[0];
            
            // 經典模式檢查牆壁碰撞
            if (currentMode === 'classic') {
                if (head.x < 0 || head.x >= canvas.width || head.y < 0 || head.y >= canvas.height) {
                    gameOver();
                    return;
                }
            }
            
            // 檢查障礙物碰撞
            if (currentMode === 'walls') {
                for (var i = 0; i < walls.length; i++) {
                    if (head.x === walls[i].x && head.y === walls[i].y) {
                        gameOver();
                        return;
                    }
                }
            }
            
            // 檢查自我碰撞 (從第4節開始檢查，因為前3節不可能碰撞)
            for (var i = 4; i < snake.length; i++) {
                if (snake[i].x === head.x && snake[i].y === head.y) {
                    gameOver();
                    return;
                }
            }
        }
        
        // 遊戲結束
        function gameOver() {
            clearInterval(gameInterval);
            gameStarted = false;
            
            // 顯示遊戲結束模態框
            finalScoreDisplay.textContent = score;
            finalHighScoreDisplay.textContent = highScore;
            gameOverModal.style.display = 'block';
        }
        
        // 遊戲主循環
        function gameLoop() {
            updateSnake();
            checkCollision();
            drawGame();
        }
        
        // 重新開始遊戲循環 (用於調整速度)
        function restartGameLoop() {
            clearInterval(gameInterval);
            gameInterval = setInterval(gameLoop, speed);
        }
        
        // 改變方向
        function changeDirection(newDirection) {
            // 如果遊戲未開始，開始遊戲
            if (!gameStarted) {
                gameStarted = true;
                initGame();
                return;
            }
            
            // 防止180度轉向
            if (
                (direction === 'UP' && newDirection !== 'DOWN') ||
                (direction === 'DOWN' && newDirection !== 'UP') ||
                (direction === 'LEFT' && newDirection !== 'RIGHT') ||
                (direction === 'RIGHT' && newDirection !== 'LEFT')
            ) {
                nextDirection = newDirection;
            }
        }
        
        // 事件監聽器
        document.addEventListener('keydown', function(e) {
            // 空格鍵暫停/繼續
            if (e.key === ' ' || e.key === 'Spacebar') { // 兼容舊版瀏覽器
                isPaused = !isPaused;
                if (isPaused) {
                    clearInterval(gameInterval);
                } else if (gameStarted) {
                    restartGameLoop();
                }
                drawGame();
                return;
            }
            
            // WASD 鍵控制
            if (e.key === 'w' || e.key === 'W') changeDirection('UP');
            if (e.key === 's' || e.key === 'S') changeDirection('DOWN');
            if (e.key === 'a' || e.key === 'A') changeDirection('LEFT');
            if (e.key === 'd' || e.key === 'D') changeDirection('RIGHT');
            
            // 方向鍵控制
            if (e.key === 'ArrowUp') changeDirection('UP');
            if (e.key === 'ArrowDown') changeDirection('DOWN');
            if (e.key === 'ArrowLeft') changeDirection('LEFT');
            if (e.key === 'ArrowRight') changeDirection('RIGHT');
            
            // 其他按鍵開始遊戲 (如果未開始)
            if (!gameStarted && (
                e.key === 'ArrowUp' || e.key === 'ArrowDown' || 
                e.key === 'ArrowLeft' || e.key === 'ArrowRight' ||
                e.key === 'w' || e.key === 'W' || e.key === 's' || e.key === 'S' ||
                e.key === 'a' || e.key === 'A' || e.key === 'd' || e.key === 'D'
            )) {
                gameStarted = true;
                initGame();
            }
        });
        
        // 按鈕事件
        newGameBtn.addEventListener('click', initGame);
        helpBtn.addEventListener('click', function() { helpModal.style.display = 'block'; });
        closeHelpBtn.addEventListener('click', function() { helpModal.style.display = 'none'; });
        restartBtn.addEventListener('click', function() {
            gameOverModal.style.display = 'none';
            initGame();
        });
        homeButton.addEventListener('click', function() {
            window.location.href = "index.html";
        });
        
        // 模式選擇按鈕
        modeBtns.forEach(function(btn) {
            btn.addEventListener('click', function() {
                // 移除所有active類
                modeBtns.forEach(function(b) {
                    b.classList.remove('active');
                });
                
                // 添加active類到當前按鈕
                this.classList.add('active');
                
                // 設置當前模式
                currentMode = this.dataset.mode;
                
                // 如果是遊戲中，重新開始遊戲
                if (gameStarted) {
                    initGame();
                }
            });
        });
        
        // 點擊模態框外部關閉
        window.addEventListener('click', function(e) {
            if (e.target === helpModal) helpModal.style.display = 'none';
            if (e.target === gameOverModal) gameOverModal.style.display = 'none';
        });
        
        // 窗口大小改變時調整畫布
        window.addEventListener('resize', function() {
            if (gameStarted) {
                initGame();
            } else {
                drawGame();
            }
        });
        
        // 初始化繪製
        drawGame();
    </script>
</body>
</html>
